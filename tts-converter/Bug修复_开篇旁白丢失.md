# Bug修复记录：开篇旁白丢失问题

## 日期：2025-01-26

## 问题描述

**项目**：异世界骑士广播剧

**症状**：
- 脚本开头的剧情旁白被误删
- 原文："【旁白】魔王城矗立在荒凉的平原之上，阴森的紫黑色云层压得很低..."
- 实际：第一段对话从主角台词开始，缺少背景交代

**影响**：
- 对话数量从50个减少到44个
- 音频文件从2.2MB减少到1.8MB
- 广播剧缺少背景介绍，听众难以理解剧情

## 根本原因

### 1. 脚本格式复杂

```markdown
### **角色列表**

【旁白】全知视角，负责交代背景、环境渲染及转场衔接。

【莱昂】男主角，二十二岁，原本是见习骑士。内心充满槽点，一心向往退休生活，是故事的吐槽担当。

【艾莉丝】王国公主，外表完美，实则是极度理想主义的政治狂热者，逻辑清奇。

【汤姆】莱昂的侍从，热血少年，正义感过剩，声音宏亮。

【魔王】魔王城之主，优雅但疲惫，被公主的学术演讲折磨到濒临崩溃。

【国王】艾莉丝的父亲，重度女儿奴，情绪波动剧烈，容易老泪纵横。

【旁白】魔王城矗立在荒凉的平原之上，阴森的紫黑色云层压得很低。城门前，一名穿着沉重铠甲的青年骑士正驻足沉思。他叫莱昂，三个月前还是个路人甲，现在却被迫拿起了号称能斩断邪恶的圣剑。
```

### 2. 过滤逻辑缺陷

**错误的过滤方法**：
```python
# 使用关键词过滤
if any(keyword in dialogue for keyword in ['全知视角', '男主角', '王国公主', '侍从', '魔王城', '重度女儿']):
    continue
```

**问题**：
- "魔王城"在开篇旁白中出现，导致整段旁白被删除
- 没有区分"角色列表"和"实际对话"
- 简单的关键词匹配不够智能

## 解决方案

### 方法1：基于长度判断

**原理**：
- 角色列表中的描述都很短（<80字）
- 真正的对话和旁白通常较长（>80字）

**实现**：
```python
skip_intro = True  # 跳过角色列表部分

for line in lines:
    match = re.match(r'^【(.+?)】(.+)$', line)
    if match:
        role, dialogue = match.groups()

        # 找到第一个长对话，说明角色列表结束
        if skip_intro and len(dialogue) > 80:
            skip_intro = False

        # 跳过角色列表
        if skip_intro:
            continue

        # 处理对话...
```

### 方法2：基于位置判断

**原理**：
- 第一个长对话（>80字）之前的所有内容都是角色列表
- 第一个长对话通常是开篇旁白，必须保留

**优点**：
- 不依赖内容关键词
- 适应各种脚本格式
- 准确率高

## 修复验证

### 修复前
```
Total: 44 dialogues

First dialogue:
【莱昂】唉，人生剧本是不是拿错了。
```

### 修复后
```
Total: 50 dialogues

First dialogue:
【旁白】魔王城矗立在荒凉的平原之上，阴森的紫黑色云层压得很低。城门前，一名穿着沉重铠甲的青年骑士正驻足沉思。他叫莱昂，三个月前还是个路人甲，现在却被迫拿起了号称能斩断邪恶的圣剑。
```

## 经验总结

### ✅ 正确做法

1. **识别脚本结构**：
   - 区分"角色列表"部分和"实际对话"部分
   - 角色列表通常是短描述（<80字）
   - 实际对话通常是长内容（>80字）

2. **保留开篇旁白**：
   - 开篇旁白用来交代背景、场景
   - 长度通常>80字
   - 包含地点、环境、人物等关键信息

3. **避免关键词过滤**：
   - 不要用内容中的关键词来判断
   - 不要删除包含特定词汇的对话
   - 用长度和位置来判断更可靠

### ❌ 错误做法

1. **简单关键词匹配**：
   ```python
   if '魔王城' in dialogue:  # 错误！会误删开篇旁白
       continue
   ```

2. **不区分脚本结构**：
   - 把所有内容当作对话处理
   - 导致角色描述混入对话

3. **忽略开篇旁白**：
   - 认为第一段对话不重要
   - 实际上开篇旁白是剧情的基础

## 通用解决方案

创建了改进的提取工具 `extract_dialogues_v2.py`：

```bash
# 基础使用
python extract_dialogues_v2.py 脚本.md -o 对话.txt

# 保留角色列表
python extract_dialogues_v2.py 脚本.md -o 对话.txt --keep-role-list

# 自定义最小长度
python extract_dialogues_v2.py 脚本.md -o 对话.txt --min-length 100

# 不替换冒号
python extract_dialogues_v2.py 脚本.md -o 对话.txt --no-replace-colons
```

## 更新文档

已更新以下文档：
1. **SKILL.md**：添加格式3（Markdown复杂格式）说明
2. **SKILL.md**：添加问题4（开篇旁白被误删）
3. **SKILL.md**：更新最佳实践（添加脚本结构识别）
4. **extract_dialogues_v2.py**：创建通用提取工具

## 关键原则

⭐ **每个广播剧开头的长旁白（>80字）都保留，用来交代背景！**

这是广播剧制作的重要经验，必须在所有项目中遵守。
